# Complete Backend Folder Structure & Flow

## ğŸ“ Folder Structure

```
/server/
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ db.js
â”‚
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ stockController.js
â”‚   â””â”€â”€ watchlistController.js
â”‚
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ Stock.js
â”‚   â””â”€â”€ Watchlist.js
â”‚
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ stockRoutes.js
â”‚   â””â”€â”€ watchlistRoutes.js
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ finnhub.js
â”‚   â”œâ”€â”€ rateLimiter.js
â”‚   â””â”€â”€ technicalIndicators.js
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ fetchAllStocks.js
â”‚
â”œâ”€â”€ server.js
â”œâ”€â”€ package.json
â”œâ”€â”€ .env
â”œâ”€â”€ .env.example
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

---

## ğŸ“„ Detailed File Contents & Flow

### 1ï¸âƒ£ **Entry Point: `server.js`**

**Purpose:** Main application entry point that starts the Express server

**Contains:**
- Load environment variables (`dotenv`)
- Import Express and middleware (cors, body-parser)
- Connect to MongoDB database
- Register API routes
- Set up cron jobs for scheduled tasks
- Start the HTTP server

**Flow:**
```
START
  â†“
Load .env â†’ Connect MongoDB â†’ Setup Middleware â†’ Register Routes â†’ Start Server
```

**Key Code:**
```javascript
require('dotenv').config();
const express = require('express');
const connectDB = require('./config/db');
const stockRoutes = require('./routes/stockRoutes');
const watchlistRoutes = require('./routes/watchlistRoutes');

connectDB(); // Connect to MongoDB
app.use('/api/stocks', stockRoutes); // Register routes
app.listen(PORT); // Start server
```

---

### 2ï¸âƒ£ **Configuration: `config/db.js`**

**Purpose:** Handle MongoDB connection

**Contains:**
- MongoDB connection string from environment
- Connection options
- Error handling for failed connections

**Flow:**
```
Load MONGODB_URI from .env â†’ Connect using Mongoose â†’ Log success/error
```

**Key Code:**
```javascript
mongoose.connect(process.env.MONGODB_URI)
  .then(() => console.log('MongoDB Connected'))
  .catch((err) => console.error(err));
```

---

### 3ï¸âƒ£ **Models: `models/Stock.js` & `models/Watchlist.js`**

**Purpose:** Define database schemas and data structure

#### **Stock.js**
**Contains:**
- Stock schema with fields:
  - symbol, companyName, currentPrice
  - entryPrice, stopLoss, targetPrice
  - successProbability, riskToReward, trend
  - ema20, ema50, rsi, macd
  - volume, marketCap, lastFetched
- Indexes for faster queries (symbol, trend, lastFetched)
- Validation rules

**Schema Structure:**
```javascript
{
  symbol: String (required, unique),
  currentPrice: Number (required),
  trend: Enum ['Uptrend', 'Downtrend', 'Neutral'],
  riskToReward: Number,
  lastFetched: Date,
  // ... other fields
}
```

#### **Watchlist.js**
**Contains:**
- Watchlist schema with fields:
  - name, description
  - stocks (array of Stock IDs - references)
  - stockSymbols (array of symbol strings)
  - lastRefetched
- Population setup for fetching related stocks

**Schema Structure:**
```javascript
{
  name: String (required),
  stocks: [ObjectId] (references Stock model),
  stockSymbols: [String],
  lastRefetched: Date
}
```

---

### 4ï¸âƒ£ **Utilities: `utils/` folder**

#### **A. `finnhub.js`**
**Purpose:** Wrapper for Finnhub API calls

**Contains:**
- API configuration (base URL, API key)
- Methods for different API endpoints:
  - `getQuote(symbol)` - Get current price
  - `getCompanyProfile(symbol)` - Get company info
  - `getBasicFinancials(symbol)` - Get financial metrics
  - `getCandles(symbol, from, to)` - Get historical data
- Error handling for failed API calls

**Flow:**
```
Request â†’ Build URL with params â†’ Add API key â†’ Make HTTP request â†’ Return data
```

**Key Methods:**
```javascript
async getQuote(symbol) {
  // Returns: { c: currentPrice, h: high, l: low, o: open, v: volume }
}

async getCandles(symbol, resolution, from, to) {
  // Returns: { c: [closes], h: [highs], l: [lows], ... }
}
```

---

#### **B. `rateLimiter.js`**
**Purpose:** Control API call rate to respect Finnhub limits (60/min)

**Contains:**
- Rate limit configuration (calls per minute)
- Delay calculation (60s / 60 calls = 1s delay)
- `sleep()` method for pausing execution
- `execute()` method for single API call with delay
- `executeBatch()` method for processing arrays

**Flow:**
```
Call API â†’ Wait (delay) â†’ Call next API â†’ Repeat
```

**Key Code:**
```javascript
delay = (60 * 1000) / callsPerMinute; // 1000ms between calls

async execute(fn) {
  const result = await fn();
  await sleep(this.delay); // Wait before next call
  return result;
}
```

---

#### **C. `technicalIndicators.js`**
**Purpose:** Calculate trading indicators from price data

**Contains:**
- **EMA calculation** (20-day & 50-day)
- **RSI calculation** (14-day default)
- **MACD calculation** (12, 26, 9 periods)
- **Trend determination** logic
- **Risk-to-Reward calculation**
- **Success Probability calculation** (custom formula)

**Flow:**
```
Historical Prices â†’ Calculate EMA/RSI/MACD â†’ Determine Trend â†’ Calculate R:R â†’ Calculate Success %
```

**Key Methods:**
```javascript
calculateEMA(prices, period) {
  // Input: [100, 102, 105, ...]
  // Output: 103.5 (latest EMA value)
}

determineTrend(ema20, ema50, currentPrice) {
  if (price > ema20 && ema20 > ema50) return 'Uptrend';
  if (price < ema20 && ema20 < ema50) return 'Downtrend';
  return 'Neutral';
}

calculateRiskToReward(entry, stopLoss, target) {
  risk = |entry - stopLoss|;
  reward = |target - entry|;
  return reward / risk; // e.g., 2.5 (means 2.5:1 R:R)
}

calculateSuccessProbability(rsi, trend, riskToReward) {
  // Base: 50%
  // +15% if Uptrend, -15% if Downtrend
  // +10% if RSI < 30 (oversold)
  // +10% if R:R >= 3
  // Returns: 0-100
}
```

---

### 5ï¸âƒ£ **Controllers: `controllers/` folder**

#### **A. `stockController.js`**
**Purpose:** Business logic for stock operations

**Contains 4 main functions:**

##### **1. `getStocks(req, res)`**
**Purpose:** Retrieve stocks from database with optional filters

**Flow:**
```
Receive request â†’ Parse query params (trend, price range, R:R) â†’ 
Build MongoDB filter â†’ Query database â†’ Return filtered stocks
```

**Example Request:**
```
GET /api/stocks?trend=Uptrend&minRiskReward=2&minPrice=50
```

**Response:**
```json
{
  "success": true,
  "count": 45,
  "data": [...]
}
```

---

##### **2. `refetchStock(req, res)`**
**Purpose:** Refresh data for a single stock

**Flow:**
```
Get symbol from URL â†’ Call Finnhub API â†’ Calculate indicators â†’ 
Update/Insert in DB â†’ Return updated stock
```

**Steps:**
1. Extract symbol from `req.params`
2. Call `finnhubAPI.getQuote(symbol)`
3. Call `finnhubAPI.getCandles(symbol)` for historical data
4. Calculate EMA, RSI, MACD using `technicalIndicators`
5. Determine trend and success probability
6. Update MongoDB using `findOneAndUpdate()`

**Example Request:**
```
GET /api/stocks/refetch/AAPL
```

---

##### **3. `fetchMultipleStocks(req, res)`**
**Purpose:** Fetch data for multiple stocks with rate limiting

**Flow:**
```
Receive array of symbols â†’ Loop through each â†’ Apply rate limiter â†’ 
Fetch data â†’ Calculate indicators â†’ Save to DB â†’ Track success/failed
```

**Steps:**
1. Get `symbols` array from request body
2. Loop through each symbol
3. Use `rateLimiter.execute()` for each call (1s delay)
4. Track successful and failed fetches
5. Return summary of results

**Example Request:**
```
POST /api/stocks/fetch-multiple
Body: { "symbols": ["AAPL", "MSFT", "GOOGL"] }
```

**Response:**
```json
{
  "success": true,
  "message": "Fetched 3 out of 3 stocks",
  "results": {
    "success": ["AAPL", "MSFT", "GOOGL"],
    "failed": []
  }
}
```

---

##### **4. `deleteStock(req, res)`**
**Purpose:** Remove a stock from database

**Flow:**
```
Get symbol â†’ Delete from MongoDB â†’ Return confirmation
```

---

#### **B. `watchlistController.js`**
**Purpose:** Business logic for watchlist operations

**Contains 6 main functions:**

##### **1. `createWatchlist(req, res)`**
**Flow:**
```
Receive name & stock symbols â†’ Find stocks in DB â†’ 
Create watchlist with stock references â†’ Save to DB
```

##### **2. `getWatchlists(req, res)`**
**Flow:**
```
Query all watchlists â†’ Populate stock details â†’ Return with full stock data
```

##### **3. `getWatchlist(req, res)`**
**Flow:**
```
Get watchlist ID â†’ Find in DB â†’ Populate stocks â†’ Return single watchlist
```

##### **4. `updateWatchlist(req, res)`**
**Flow:**
```
Get watchlist ID â†’ Update name/symbols â†’ Find new stocks â†’ Update DB
```

##### **5. `refetchWatchlist(req, res)`**
**Purpose:** Refresh all stocks in a watchlist

**Flow:**
```
Get watchlist ID â†’ Get all symbols â†’ Loop through symbols â†’ 
Apply rate limiter â†’ Fetch each stock â†’ Update DB â†’ 
Update lastRefetched timestamp
```

**Steps:**
1. Find watchlist by ID
2. Get `stockSymbols` array
3. Loop through each symbol with rate limiting
4. Call `fetchStockData()` for each
5. Update each stock in database
6. Update watchlist's `lastRefetched` field
7. Return summary (success/failed counts)

##### **6. `deleteWatchlist(req, res)`**
**Flow:**
```
Get watchlist ID â†’ Delete from DB â†’ Return confirmation
```

---

### 6ï¸âƒ£ **Routes: `routes/` folder**

#### **A. `stockRoutes.js`**
**Purpose:** Define API endpoints for stocks

**Routes:**
```javascript
GET    /api/stocks                    â†’ getStocks()
GET    /api/stocks/refetch/:symbol    â†’ refetchStock()
POST   /api/stocks/fetch-multiple     â†’ fetchMultipleStocks()
DELETE /api/stocks/:symbol            â†’ deleteStock()
```

**Flow:**
```
HTTP Request â†’ Match route â†’ Call controller function â†’ Return response
```

---

#### **B. `watchlistRoutes.js`**
**Purpose:** Define API endpoints for watchlists

**Routes:**
```javascript
POST   /api/watchlists           â†’ createWatchlist()
GET    /api/watchlists           â†’ getWatchlists()
GET    /api/watchlists/:id       â†’ getWatchlist()
PUT    /api/watchlists/:id       â†’ updateWatchlist()
GET    /api/watchlists/:id/refetch â†’ refetchWatchlist()
DELETE /api/watchlists/:id       â†’ deleteWatchlist()
```

---

### 7ï¸âƒ£ **Scripts: `scripts/fetchAllStocks.js`**

**Purpose:** One-time script to fetch 2700 stocks

**Flow:**
```
Connect to MongoDB â†’ Load stock symbols array â†’ 
Loop through all symbols â†’ Apply rate limiter â†’ 
Fetch each stock â†’ Calculate indicators â†’ Save to DB â†’ 
Log progress â†’ Disconnect
```

**Usage:**
```bash
npm run fetch-all
```

**Time Estimation:**
```
2700 stocks Ã· 60 calls/min = 45 minutes
```

---

## ğŸ”„ Complete Data Flow Example

### **Scenario: User refetches a watchlist**

```
1. Frontend sends: GET /api/watchlists/123/refetch

2. server.js receives request â†’ routes to watchlistRoutes.js

3. watchlistRoutes.js matches route â†’ calls refetchWatchlist()

4. refetchWatchlist() in watchlistController.js:
   â”œâ”€ Finds watchlist in MongoDB
   â”œâ”€ Gets stockSymbols: ["AAPL", "MSFT", "GOOGL"]
   â””â”€ Loops through each symbol

5. For each symbol:
   â”œâ”€ rateLimiter.execute() adds 1s delay
   â”œâ”€ finnhub.getQuote("AAPL") â†’ Gets current price
   â”œâ”€ finnhub.getCandles("AAPL") â†’ Gets historical data
   â”œâ”€ technicalIndicators.calculateEMA() â†’ Calculates EMA
   â”œâ”€ technicalIndicators.calculateRSI() â†’ Calculates RSI
   â”œâ”€ technicalIndicators.determineTrend() â†’ Determines trend
   â”œâ”€ technicalIndicators.calculateRiskToReward() â†’ Calculates R:R
   â””â”€ Stock.findOneAndUpdate() â†’ Saves to MongoDB

6. Update watchlist.lastRefetched in MongoDB

7. Return response:
   {
     "success": true,
     "message": "Refetched 3 out of 3 stocks",
     "results": { "success": [...], "failed": [] }
   }
```

---

## ğŸ“Š Database Flow

### **Stock Collection**
```
Symbol (Index) â†’ Query fast by symbol
Trend (Index) â†’ Filter by trend quickly
LastFetched (Index) â†’ Sort by freshness
```

### **Watchlist Collection**
```
Name â†’ Identify watchlist
Stocks (References) â†’ Link to Stock documents
StockSymbols â†’ Store symbols for refetching
```

**Relationship:**
```
Watchlist â†’ has many â†’ Stocks (via ObjectId references)
```

---

## âš™ï¸ Environment Variables (`.env`)

```env
PORT=5000                                    # Server port
MONGODB_URI=mongodb://localhost:27017/...   # Database URL
FINNHUB_API_KEY=your_key                    # API authentication
API_RATE_LIMIT=60                           # Calls per minute
```

---

## ğŸ¯ Key Concepts

### **Rate Limiting**
- Prevents exceeding Finnhub's 60 calls/min limit
- Adds ~1 second delay between each API call
- For 2700 stocks: 2700 Ã· 60 = 45 minutes

### **Technical Indicators**
- **EMA**: Smooth price trends (20-day & 50-day)
- **RSI**: Overbought/oversold (0-100 scale)
- **MACD**: Momentum indicator
- **Trend**: Determined by EMA crossovers

### **Database Indexing**
- Speeds up queries on frequently searched fields
- Indexes: symbol, trend, lastFetched

### **Error Handling**
- Try-catch blocks in all async functions
- Log errors to console
- Return meaningful error messages to frontend

---

## ğŸ“ Summary

**File Count:** 15 files
**Main Components:** 
- 1 Server (entry point)
- 1 Config (database)
- 2 Models (schemas)
- 3 Utils (API, rate limiter, indicators)
- 2 Controllers (business logic)
- 2 Routes (endpoints)
- 1 Script (batch fetch)
- 3 Config files (.env, .gitignore, package.json)

**Data Flow:**
```
Request â†’ Route â†’ Controller â†’ Utils/Models â†’ Database â†’ Response
```

This structure follows **MVC pattern** (Model-View-Controller) with separation of concerns for maintainability and scalability.